#!/usr/bin/env ruby
require "pathname"
require "fileutils"
include FileUtils

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../", __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.
  puts "== Installing dependencies =="
  system! "bundle install"

  # Install JavaScript dependencies if using Yarn
  # system("bin/yarn")

  # puts "\n== Copying sample files =="
  # unless File.exist?("config/database.yml")
  #   cp "config/database.yml.sample", "config/database.yml"
  # end

  puts "\n== Preparing database =="
  # system! "rails db:create"
  system! "rails db:migrate"
  system! "rails db:seed"
  
  # Generate resources
  rails generate resource proposal 
    name:text 
    description:text 
    location:string 
    status:string 
    owned_by_user_id:integer
    has_many(:steps, :dependent => :destroy)
    has_many(:comments, :dependent => :destroy)
    has_many(:stakeholders, :dependent => :destroy)
    has_many(:votes, :dependent => :destroy)
    has_many(:commitments, :dependent => :destroy)
    belongs_to(:created_by_user, :class_name => "User", :foreign_key => "owned_by_user_id")

  rails generate model user 
    profile_photo:string
    has_one{:stakeholder, :dependent => :nullify}
    has_many{:comments, :dependent => :nullify}
    has_many{:proposals, :foreign_key => "owned_by_user_id", :dependent => :nullify}
    has_many{:votes, :dependent => :destroy}
    has_many{:commitments, :dependent => :nullify}
    has_many{:stakeholders, :foreign_key => "created_by_user_id", :dependent => :nullify}

  rails generate resource comment 
    comment:text 
    user_id:integer 
    proposal_id:integer
    belongs_to:proposal
    belongs_to:user

  rails generate resource vote 
    proposal_id:integer 
    user_id:integer
    belongs_to:proposal
    belongs_to:user

  rails generate resource step 
    proposal_id:integer 
    name:string 
    status:string
    belongs_to:proposal
    has_one{:commitment, :dependent => :destroy}
    has_one{:stakeholder, :dependent => :nullify}

  rails generate resource commitment 
    proposal_id:integer 
    step_id:integer 
    user_id:integer
    belongs_to:proposal
    belongs_to:user
    belongs_to:step

  rails generate resource stakeholder 
    name:string 
    email:string 
    phone:string 
    address:string 
    created_by_user_id:integer 
    proposal_id:integer 
    step_id:integer 
    user_id:integer
    belongs_to:proposal
    belongs_to{:created_by_user, :class_name => "User"}
    belongs_to{:step, :required => false}

  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file

end
